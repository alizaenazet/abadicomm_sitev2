name: Deploy Astro Site to Production

on:
    push:
        branches: ["main"]
    repository_dispatch:
        types: [sveltia-cms-publish]

env:
    NODE_ENV: production
    DEPLOY_PATH: /root/stack/apps/abadicomm_sitev2/prod

jobs:
    build-and-deploy:
        name: Build & Deploy
        runs-on: ubuntu-latest

        steps:
            # ==========================================================
            # CHECKOUT
            # ==========================================================
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            # ==========================================================
            # SETUP BUN
            # ==========================================================
            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            # ==========================================================
            # CACHE DEPENDENCIES
            # ==========================================================
            - name: Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            # ==========================================================
            # INSTALL DEPENDENCIES
            # ==========================================================
            - name: Install dependencies
              run: bun install --frozen-lockfile

            # ==========================================================
            # BUILD ASTRO SITE
            # ==========================================================
            - name: Build Astro site
              run: bun run build

            # ==========================================================
            # CONVERT OG IMAGES TO JPEG
            # ==========================================================
            - name: Convert OG images to JPEG
              run: |
                  echo "Installing ffmpeg..."
                  sudo apt-get update && sudo apt-get install -y ffmpeg
                  
                  echo "Converting OG images from PNG to JPEG (80% quality)..."
                  
                  OG_DIR="dist/open-graph"
                  
                  if [ -d "${OG_DIR}" ]; then
                    PNG_COUNT=$(find ${OG_DIR} -name "*.png" | wc -l)
                    echo "Found ${PNG_COUNT} PNG files to convert"
                    
                    # Convert each PNG to JPEG using ffmpeg with 80% quality
                    find ${OG_DIR} -name "*.png" | while read png_file; do
                      jpeg_file="${png_file%.png}.jpeg"
                      echo "Converting: ${png_file} -> ${jpeg_file}"
                      ffmpeg -i "${png_file}" -qscale:v 5 "${jpeg_file}" -y
                      rm -f "${png_file}"
                    done
                    
                    echo "Conversion complete!"
                    echo "JPEG files created: $(find ${OG_DIR} -name "*.jpeg" | wc -l)"
                  else
                    echo "‚ö†Ô∏è No open-graph directory found, skipping conversion"
                  fi

            # ==========================================================
            # COMPRESS STATIC ASSETS (for gzip_static)
            # ==========================================================
            - name: Pre-compress static assets
              run: |
                  echo "Compressing static assets for gzip_static..."
                  find dist -type f \( \
                    -name "*.html" \
                    -o -name "*.css" \
                    -o -name "*.js" \
                    -o -name "*.svg" \
                    -o -name "*.xml" \
                    -o -name "*.json" \
                    -o -name "*.txt" \
                  \) -exec gzip -9 -k {} \;

                  echo "Compression complete!"
                  echo "Compressed files count:"
                  find dist -name "*.gz" | wc -l

            # ==========================================================
            # CREATE DEPLOYMENT ARCHIVE
            # ==========================================================
            - name: Create deployment archive
              run: |
                  # Exclude uploads directory to reduce archive size
                  tar -czf deploy.tar.gz -C dist --exclude='uploads' .
                  echo "Archive created: $(pwd)/deploy.tar.gz"
                  echo "Archive size: $(du -h deploy.tar.gz | cut -f1)"
                  echo "Files in archive: $(tar -tzf deploy.tar.gz | wc -l)"
                  ls -lh deploy.tar.gz

            # ==========================================================
            # DEPLOY TO VPS
            # ==========================================================
            - name: Deploy to VPS
              uses: burnett01/rsync-deployments@7.0.1
              with:
                  switches: -avzr --progress --timeout=120
                  path: deploy.tar.gz
                  remote_path: /tmp/
                  remote_host: ${{ secrets.VPS_HOST }}
                  remote_user: ${{ secrets.VPS_USER }}
                  remote_key: ${{ secrets.VPS_SSH_KEY }}

            # ==========================================================
            # EXTRACT & ACTIVATE DEPLOYMENT
            # ==========================================================
            - name: Extract and activate deployment
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  script: |
                      set -e

                      echo "Starting deployment..."

                      DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
                      DIST_PATH="${DEPLOY_PATH}/dist"
                      DIST_NEW_PATH="${DEPLOY_PATH}/dist_new"
                      DIST_OLD_PATH="${DEPLOY_PATH}/dist_old"
                      REPO_PATH="${DEPLOY_PATH}/abadicomm_sitev2"

                      # Create deployment directory if not exists
                      mkdir -p ${DEPLOY_PATH}

                      # Clean up any previous failed deployment
                      rm -rf ${DIST_NEW_PATH}
                      rm -rf ${DIST_OLD_PATH}

                      # Create new temporary dist directory
                      mkdir -p ${DIST_NEW_PATH}

                      # Extract new deployment to temporary directory
                      echo "Extracting new deployment to temporary directory..."
                      tar -xzf /tmp/deploy.tar.gz -C ${DIST_NEW_PATH}

                      # ==========================================================
                      # SYNC UPLOADS FROM GIT REPO
                      # ==========================================================
                      echo "Syncing uploads from git repository..."
                      cd ${REPO_PATH}
                      git fetch origin main
                      git reset --hard origin/main

                      # Create symlink for uploads directory in temp folder
                      if [ -d "${REPO_PATH}/public/uploads" ]; then
                        echo "Creating symlink for uploads..."
                        ln -sfn ${REPO_PATH}/public/uploads ${DIST_NEW_PATH}/uploads
                        echo "Symlink created: ${DIST_NEW_PATH}/uploads -> ${REPO_PATH}/public/uploads"
                      else
                        echo "‚ö†Ô∏è No uploads directory found in repo"
                      fi

                      # Set correct permissions on new deployment
                      echo "Setting permissions..."
                      chown -R www-data:www-data ${DIST_NEW_PATH}
                      chmod -R 755 ${DIST_NEW_PATH}
                      # Ensure repo uploads are also accessible
                      chown -R www-data:www-data ${REPO_PATH}/public/uploads
                      chmod -R 755 ${REPO_PATH}/public/uploads

                      # ==========================================================
                      # ATOMIC SWAP - Minimize downtime
                      # ==========================================================
                      echo "Performing atomic swap..."
                      
                      # Move current dist to old (if exists)
                      if [ -d "${DIST_PATH}" ]; then
                        mv ${DIST_PATH} ${DIST_OLD_PATH}
                      fi
                      
                      # Swap new to current (this is the only moment of potential 404)
                      mv ${DIST_NEW_PATH} ${DIST_PATH}
                      
                      echo "‚úÖ Swap complete!"

                      # Cleanup temp file
                      rm -f /tmp/deploy.tar.gz

                      # Clean up old deployment
                      echo "üßπ Cleaning up old deployment..."
                      rm -rf ${DIST_OLD_PATH}

                      # Verify deployment
                      echo "Deployment complete!"
                      echo "Deployed files:"
                      ls -la ${DIST_PATH} | head -20

                      echo ""
                      echo "üéâ Site deployed successfully with zero-downtime swap!"

            # ==========================================================
            # VERIFY DEPLOYMENT
            # ==========================================================
            - name: Verify deployment
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  script: |
                      DIST_PATH="${{ env.DEPLOY_PATH }}/dist"

                      echo "üîç Verifying deployment..."

                      # Check if index.html exists
                      if [ -f "${DIST_PATH}/index.html" ]; then
                        echo "index.html found"
                      else
                        echo "‚ùå index.html not found!"
                        exit 1
                      fi

                      # Check if _astro directory exists (Astro assets)
                      if [ -d "${DIST_PATH}/_astro" ]; then
                        echo "_astro directory found"
                        echo "Asset count: $(find ${DIST_PATH}/_astro -type f | wc -l)"
                      else
                        echo "‚ö†Ô∏è _astro directory not found (may be empty site)"
                      fi

                      # Check compressed files
                      GZ_COUNT=$(find ${DIST_PATH} -name "*.gz" | wc -l)
                      echo "Pre-compressed files: ${GZ_COUNT}"

                      # Check total size
                      echo "üíæ Total deployment size: $(du -sh ${DIST_PATH} | cut -f1)"

                      echo ""
                      echo "üéâ Verification complete!"
